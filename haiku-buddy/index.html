<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="UTF-8">
    <meta name="description" content="Haiku writer helper">
    <meta name="keywords" content="haiku, poetry, syllables counter">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Haiku buddy</title>

    <link href="https://fonts.googleapis.com/css2?family=Long+Cang&display=swap" rel="stylesheet">

    <style type="text/css">
     html, body {
         height: 100%;
         margin: 0;
     }

     main {
         margin: 0 auto;
         max-width: 800px;
     }

     #poetry {
         min-width: 600px;
         resize: none;
     }

     #counter {
         display: inline-block;
         margin: 0;
         margin-top: 3px;
         width: 25px;
         vertical-align: top;
     }

     #counter, #poetry {
         font-family: Arial, sans-serif;
         font-size: 1em;
     }
    </style>
  </head>
  <body>
    <main>
      <div id='counter'></div>
      <textarea id='poetry' rows='10'></textarea>
      <div>
        <canvas id="canvas" width="600" height="430"></canvas>
      </div>
    </main>

    <script>
     const poetry = document.querySelector("#poetry")
     const counter = document.querySelector("#counter")
     const canvas = document.querySelector("#canvas")
     const context = canvas.getContext("2d")

     const imageObj = new Image()

     // imageObj.src = "plant.jpg"
     // context.fillStyle = "#223d2a"

     imageObj.src = "koi.jpg"
     context.fillStyle = "#f1ecf2"

     imageObj.onload = function(){
         context.drawImage(imageObj, 0, 0)
         context.font = "24pt 'Long Cang'"
         updateCanvas()
     }

     poetry.addEventListener('keyup', updateCounter)

     function updateCounter() {
         counter.innerHTML =
             poetry.value
                   .split('\n')
                   .map(countSyllables)
                   .join('<br>')

         updateCanvas()
     }

     function updateCanvas() {
         context.drawImage(imageObj, 0, 0)
         let y = 120

         for (const line of poetry.value.split('\n')) {
             context.fillText(line, 50, y)
             y += 34
         }
     }

     function countSyllables(sentence) {
         const syllableRegex = /[aiouy]+e*|e(?!d\b|ly)\w|[td]ed|le\b|\b\w{1,2}e\b/gi
         const matches = sentence.match(syllableRegex)

         if (matches === null) return 0

         return matches.length
     }

     updateCounter()
    </script>
  </body>
</html>
